// MCA Underwriting System - Database Schema
// Based on PRD v2.0 - December 2025

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// SAAS MULTI-TENANT STRUCTURE
// ============================================

// Platform-level roles (SaaS Admins)
enum PlatformRole {
  SUPER_ADMIN      // Full platform access
  PLATFORM_ADMIN   // Platform management
  PLATFORM_SUPPORT // Support access
}

// Company-level roles (Client employees)
enum CompanyRole {
  COMPANY_OWNER    // Full company access
  COMPANY_ADMIN    // Company admin
  MANAGER          // Department manager
  UNDERWRITER      // Underwriting staff
  SALES            // Sales staff
  COLLECTIONS      // Collections staff
  COMPLIANCE       // Compliance staff
  VIEWER           // Read-only access
}

// SaaS Company (Client/Tenant)
model Company {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique // URL-friendly identifier

  // Company Details
  legalName       String?
  taxId           String?
  phone           String?
  email           String?
  website         String?

  // Address
  address         String?
  city            String?
  state           String?
  zipCode         String?
  country         String        @default("US")

  // Branding
  logoUrl         String?
  primaryColor    String?       @default("#3B82F6")

  // Subscription & Billing
  subscriptionId  String?       @unique
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])

  // Status
  status          CompanyStatus @default(TRIAL)
  trialEndsAt     DateTime?

  // Settings
  settings        Json?         // Company-specific settings

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relationships
  users           User[]
  merchants       Merchant[]
  brokers         Broker[]
  apiKeys         ApiKey[]
  invoices        Invoice[]
  paymentMethods  PaymentMethod[]

  // Marketing relationships
  campaigns       Campaign[]
  marketingLeads  MarketingLead[]
  callLogs        CallLog[]
  contentPosts    ContentPost[]
  socialAccounts  SocialAccount[]

  @@map("companies")
}

enum CompanyStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
  PAST_DUE
}

// Subscription Plans
model Plan {
  id              String        @id @default(cuid())
  name            String        // Starter, Professional, Enterprise
  slug            String        @unique
  description     String?

  // Pricing
  monthlyPrice    Decimal       @db.Decimal(10, 2)
  yearlyPrice     Decimal       @db.Decimal(10, 2)

  // Limits
  maxUsers        Int           @default(5)
  maxMerchants    Int           @default(100)
  maxDealsPerMonth Int          @default(50)
  maxStorageGb    Int           @default(10)

  // Features
  features        String[]      // Feature flags

  isActive        Boolean       @default(true)
  sortOrder       Int           @default(0)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  subscriptions   Subscription[]

  @@map("plans")
}

model Subscription {
  id              String              @id @default(cuid())
  planId          String

  // Billing Cycle
  billingCycle    BillingCycle        @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Status
  status          SubscriptionStatus  @default(ACTIVE)
  cancelledAt     DateTime?
  cancelAtPeriodEnd Boolean           @default(false)

  // Payment Provider
  stripeSubscriptionId String?        @unique
  stripeCustomerId     String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  plan            Plan                @relation(fields: [planId], references: [id])
  company         Company?

  @@map("subscriptions")
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  UNPAID
  TRIALING
}

// Payment Methods for Companies
model PaymentMethod {
  id              String              @id @default(cuid())
  companyId       String

  // Card Details (stored by Stripe, we keep reference)
  type            PaymentMethodType   @default(CARD)
  stripePaymentMethodId String?       @unique

  // Display info (last 4 digits, brand)
  last4           String?
  brand           String?             // visa, mastercard, amex
  expiryMonth     Int?
  expiryYear      Int?

  // Billing Address
  billingName     String?
  billingEmail    String?

  isDefault       Boolean             @default(false)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

enum PaymentMethodType {
  CARD
  BANK_ACCOUNT
  ACH
}

// Invoices
model Invoice {
  id              String          @id @default(cuid())
  companyId       String

  // Invoice Details
  invoiceNumber   String          @unique
  amount          Decimal         @db.Decimal(10, 2)
  tax             Decimal         @db.Decimal(10, 2) @default(0)
  total           Decimal         @db.Decimal(10, 2)
  currency        String          @default("USD")

  // Period
  periodStart     DateTime
  periodEnd       DateTime

  // Status
  status          InvoiceStatus   @default(DRAFT)
  dueDate         DateTime
  paidAt          DateTime?

  // Payment Provider
  stripeInvoiceId String?         @unique

  // PDF
  pdfUrl          String?

  // Line items stored as JSON
  lineItems       Json?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  company         Company         @relation(fields: [companyId], references: [id])

  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// API Keys for companies
model ApiKey {
  id              String        @id @default(cuid())
  companyId       String

  name            String
  key             String        @unique
  keyHash         String        // Hashed version for security

  // Permissions
  permissions     String[]      // read, write, delete, etc.

  // Rate Limiting
  rateLimit       Int           @default(1000) // requests per hour

  // Status
  isActive        Boolean       @default(true)
  lastUsedAt      DateTime?
  expiresAt       DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  emailVerified   DateTime?
  name            String?
  password        String?
  image           String?
  phone           String?

  // Multi-tenant support
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])

  // Role system - platform admin OR company employee
  platformRole    PlatformRole? // Only set for SaaS admins
  companyRole     CompanyRole?  // Only set for company employees

  // Legacy role for backward compatibility
  role            UserRole      @default(SALES)

  isActive        Boolean       @default(true)
  lastLoginAt     DateTime?

  // Supabase Auth ID
  supabaseId      String?       @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts      Account[]
  sessions      Session[]

  // Relationships
  assignedDeals     Deal[]     @relation("AssignedUnderwriter")
  createdDeals      Deal[]     @relation("CreatedBy")
  assignedMerchants Merchant[] @relation("AssignedSalesRep")
  auditLogs         AuditLog[]
  notifications     Notification[]
  comments          Comment[]
  invitationsSent   Invitation[] @relation("InvitedBy")

  @@index([companyId])
  @@map("users")
}

// User Invitations
model Invitation {
  id            String        @id @default(cuid())
  email         String
  companyId     String?
  companyRole   CompanyRole?
  platformRole  PlatformRole?

  token         String        @unique
  expiresAt     DateTime

  status        InvitationStatus @default(PENDING)
  acceptedAt    DateTime?

  invitedById   String?
  invitedBy     User?         @relation("InvitedBy", fields: [invitedById], references: [id])

  createdAt     DateTime      @default(now())

  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Legacy role enum - kept for backward compatibility
enum UserRole {
  ADMIN
  UNDERWRITER
  SALES
  COLLECTIONS
  COMPLIANCE
  EXECUTIVE
  BROKER
}

// ============================================
// MERCHANT & OWNER MANAGEMENT
// ============================================

model Merchant {
  id               String   @id @default(cuid())

  // Multi-tenant support
  companyId        String?
  company          Company? @relation(fields: [companyId], references: [id])

  legalName        String
  dbaName          String?
  ein              String?  @unique
  businessType     BusinessType
  industryCode     String?
  industryRiskTier IndustryRiskTier @default(B)

  // Contact Information
  phone            String?
  email            String?
  website          String?

  // Address
  address          String?
  city             String?
  state            String?
  zipCode          String?

  // Business Details
  dateEstablished  DateTime?
  timeInBusiness   Int?      // months
  annualRevenue    Decimal?  @db.Decimal(15, 2)
  monthlyRevenue   Decimal?  @db.Decimal(15, 2)
  employeeCount    Int?

  // Banking Information (encrypted in practice)
  bankName         String?
  routingNumber    String?
  accountNumber    String?

  // Status
  status           MerchantStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  owners           Owner[]
  deals            Deal[]
  advances         Advance[]
  documents        Document[]
  uccFilings       UCCFiling[]
  assignedSalesRep User?      @relation("AssignedSalesRep", fields: [salesRepId], references: [id])
  salesRepId       String?

  @@index([companyId])
  @@map("merchants")
}

model Owner {
  id           String   @id @default(cuid())
  merchantId   String
  firstName    String
  lastName     String
  email        String?
  phone        String?
  ssn          String?  // encrypted
  dateOfBirth  DateTime?
  ownership    Decimal  @db.Decimal(5, 2) // percentage
  isPrimary    Boolean  @default(false)

  // Address
  address      String?
  city         String?
  state        String?
  zipCode      String?

  // Credit Information
  ficoScore    Int?
  creditPullDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  merchant     Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  creditReports CreditReport[]

  @@map("owners")
}

enum BusinessType {
  SOLE_PROPRIETORSHIP
  LLC
  CORPORATION
  PARTNERSHIP
  NONPROFIT
  OTHER
}

enum MerchantStatus {
  ACTIVE
  INACTIVE
  BLACKLISTED
  PROSPECT
}

enum IndustryRiskTier {
  A  // Low risk
  B  // Moderate risk
  C  // Higher risk
  D  // High risk / Prohibited
}

// ============================================
// CRM & PIPELINE MANAGEMENT
// ============================================

model Deal {
  id                String      @id @default(cuid())
  merchantId        String

  // Deal Information
  requestedAmount   Decimal     @db.Decimal(15, 2)
  approvedAmount    Decimal?    @db.Decimal(15, 2)
  factorRate        Decimal?    @db.Decimal(5, 4)
  paybackAmount     Decimal?    @db.Decimal(15, 2)
  termDays          Int?
  dailyPayment      Decimal?    @db.Decimal(15, 2)
  weeklyPayment     Decimal?    @db.Decimal(15, 2)

  // Pipeline Stage
  stage             DealStage   @default(NEW_LEAD)
  stageChangedAt    DateTime    @default(now())

  // Source & Tracking
  source            LeadSource  @default(DIRECT)
  brokerId          String?
  commission        Decimal?    @db.Decimal(15, 2)
  commissionRate    Decimal?    @db.Decimal(5, 4)

  // Risk Assessment
  paperGrade        PaperGrade?
  riskScore         Int?        // 0-100
  stackingDetected  Boolean     @default(false)
  existingPositions Int         @default(0)

  // Decision
  decisionDate      DateTime?
  decisionNotes     String?     @db.Text
  declineReasons    String[]

  // Timing
  submittedAt       DateTime    @default(now())
  fundedAt          DateTime?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relationships
  merchant          Merchant    @relation(fields: [merchantId], references: [id])
  broker            Broker?     @relation(fields: [brokerId], references: [id])
  underwriter       User?       @relation("AssignedUnderwriter", fields: [underwriterId], references: [id])
  underwriterId     String?
  createdBy         User?       @relation("CreatedBy", fields: [createdById], references: [id])
  createdById       String?

  documents         Document[]
  bankAnalysis      BankAnalysis?
  disclosures       Disclosure[]
  contracts         Contract[]
  advances          Advance[]
  comments          Comment[]
  stageHistory      DealStageHistory[]

  @@index([stage])
  @@index([merchantId])
  @@index([brokerId])
  @@map("deals")
}

model DealStageHistory {
  id          String    @id @default(cuid())
  dealId      String
  fromStage   DealStage?
  toStage     DealStage
  changedAt   DateTime  @default(now())
  changedBy   String?
  notes       String?

  deal        Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("deal_stage_history")
}

enum DealStage {
  NEW_LEAD
  DOCS_REQUESTED
  DOCS_RECEIVED
  IN_UNDERWRITING
  APPROVED
  CONTRACT_SENT
  CONTRACT_SIGNED
  FUNDED
  DECLINED
  DEAD
}

enum LeadSource {
  DIRECT
  BROKER
  REFERRAL
  WEBSITE
  EMAIL
  IMPORT
}

enum PaperGrade {
  A
  B
  C
  D
}

// ============================================
// BROKER/ISO MANAGEMENT
// ============================================

model Broker {
  id              String        @id @default(cuid())

  // Multi-tenant support
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])

  companyName     String
  contactName     String
  email           String        @unique
  phone           String?

  // Commission Structure
  tier            BrokerTier    @default(STANDARD)
  commissionRate  Decimal       @db.Decimal(5, 4) @default(0.10) // 10%

  // Portal Access
  portalEnabled   Boolean       @default(true)
  apiKey          String?       @unique
  whiteLabel      Boolean       @default(false)

  // Status
  status          BrokerStatus  @default(ACTIVE)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  deals           Deal[]
  commissions     Commission[]

  @@index([companyId])
  @@map("brokers")
}

model Commission {
  id            String            @id @default(cuid())
  brokerId      String
  advanceId     String
  amount        Decimal           @db.Decimal(15, 2)
  rate          Decimal           @db.Decimal(5, 4)
  status        CommissionStatus  @default(PENDING)

  // Clawback tracking
  clawbackEligible Boolean        @default(true)
  clawbackDate     DateTime?
  clawbackAmount   Decimal?        @db.Decimal(15, 2)

  paidAt           DateTime?
  paymentReference String?

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  broker        Broker            @relation(fields: [brokerId], references: [id])
  advance       Advance           @relation(fields: [advanceId], references: [id])

  @@map("commissions")
}

enum BrokerTier {
  STANDARD   // 10%
  PREFERRED  // 12%
  PREMIUM    // 15%
}

enum BrokerStatus {
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CLAWED_BACK
}

// ============================================
// UNDERWRITING ENGINE
// ============================================

model BankAnalysis {
  id                String   @id @default(cuid())
  dealId            String   @unique

  // Statement Period
  periodStart       DateTime
  periodEnd         DateTime
  monthsAnalyzed    Int

  // Balance Metrics
  avgDailyBalance   Decimal  @db.Decimal(15, 2)
  minBalance        Decimal  @db.Decimal(15, 2)
  maxBalance        Decimal  @db.Decimal(15, 2)
  endingBalance     Decimal  @db.Decimal(15, 2)

  // Deposit Analysis
  totalDeposits     Decimal  @db.Decimal(15, 2)
  depositCount      Int
  avgDeposit        Decimal  @db.Decimal(15, 2)
  depositDaysCount  Int      // days with deposits

  // NSF & Overdraft
  nsfCount          Int      @default(0)
  nsfAmount         Decimal  @db.Decimal(15, 2) @default(0)
  overdraftCount    Int      @default(0)

  // MCA Detection
  detectedMCAPayments Json?   // Array of detected recurring ACH debits
  estimatedDailyLoad  Decimal? @db.Decimal(15, 2)

  // Revenue Trend
  revenueTrend      RevenueTrend @default(STABLE)

  // OCR Source
  ocrProvider       String?
  ocrConfidence     Decimal?  @db.Decimal(5, 4)
  rawOcrData        Json?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("bank_analyses")
}

model CreditReport {
  id              String   @id @default(cuid())
  ownerId         String

  // Credit Scores
  ficoScore       Int?
  vantageScore    Int?

  // Credit Details
  creditBureau    String?  // Experian, Equifax, TransUnion
  pullDate        DateTime
  reportReference String?

  // Key Factors
  openAccounts    Int?
  totalDebt       Decimal? @db.Decimal(15, 2)
  creditUtilization Decimal? @db.Decimal(5, 4)

  // Negative Items
  bankruptcies    Int      @default(0)
  judgments       Int      @default(0)
  liens           Int      @default(0)
  collections     Int      @default(0)

  // Raw Report
  rawReportData   Json?

  createdAt       DateTime @default(now())

  owner           Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("credit_reports")
}

enum RevenueTrend {
  GROWING
  STABLE
  DECLINING
}

// ============================================
// DOCUMENT MANAGEMENT
// ============================================

model Document {
  id            String         @id @default(cuid())
  merchantId    String?
  dealId        String?

  // File Information
  fileName      String
  fileType      String
  fileSize      Int
  mimeType      String
  storageKey    String         // S3/Supabase key
  storageUrl    String?

  // Document Classification
  documentType  DocumentType

  // Status
  status        DocumentStatus @default(PENDING)

  // OCR Results
  ocrProcessed  Boolean        @default(false)
  ocrData       Json?

  // Verification
  verified      Boolean        @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  merchant      Merchant?      @relation(fields: [merchantId], references: [id])
  deal          Deal?          @relation(fields: [dealId], references: [id])

  @@map("documents")
}

enum DocumentType {
  BANK_STATEMENT
  APPLICATION
  GOVERNMENT_ID
  VOIDED_CHECK
  CC_PROCESSING_STATEMENT
  TAX_RETURN
  BUSINESS_LICENSE
  CONTRACT
  DISCLOSURE
  OTHER
}

enum DocumentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REJECTED
}

// ============================================
// COMPLIANCE & REGULATORY
// ============================================

model Disclosure {
  id              String           @id @default(cuid())
  dealId          String
  state           String           // CA, NY, VA, UT

  // Disclosure Details
  disclosureType  DisclosureType
  version         String           @default("1.0")

  // Calculated Values
  totalAdvance    Decimal          @db.Decimal(15, 2)
  totalPayback    Decimal          @db.Decimal(15, 2)
  financeCharge   Decimal          @db.Decimal(15, 2)
  aprEquivalent   Decimal?         @db.Decimal(6, 4)

  // Payment Schedule
  paymentSchedule Json?

  // Generated Document
  documentUrl     String?
  generatedAt     DateTime?

  // Signature
  signedAt        DateTime?
  signatureId     String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  deal            Deal             @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("disclosures")
}

model UCCFiling {
  id              String        @id @default(cuid())
  merchantId      String
  advanceId       String?

  // Filing Details
  filingType      UCCFilingType
  filingState     String
  filingNumber    String?

  // Status
  status          UCCStatus     @default(PENDING)
  filedAt         DateTime?
  expiresAt       DateTime?

  // Collateral Description
  collateralDesc  String?       @db.Text

  // Amendment/Continuation tracking
  parentFilingId  String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  merchant        Merchant      @relation(fields: [merchantId], references: [id])
  advance         Advance?      @relation(fields: [advanceId], references: [id])
  parentFiling    UCCFiling?    @relation("UCCAmendments", fields: [parentFilingId], references: [id])
  amendments      UCCFiling[]   @relation("UCCAmendments")

  @@map("ucc_filings")
}

enum DisclosureType {
  CALIFORNIA_SB1235
  NEW_YORK_SB5470
  VIRGINIA
  UTAH
}

enum UCCFilingType {
  UCC1
  UCC3_AMENDMENT
  UCC3_CONTINUATION
  UCC3_TERMINATION
}

enum UCCStatus {
  PENDING
  FILED
  ACCEPTED
  REJECTED
  EXPIRED
  TERMINATED
}

// ============================================
// CONTRACTS & E-SIGNATURE
// ============================================

model Contract {
  id              String          @id @default(cuid())
  dealId          String

  // Contract Details
  contractType    ContractType
  version         String          @default("1.0")

  // Terms
  advanceAmount   Decimal         @db.Decimal(15, 2)
  paybackAmount   Decimal         @db.Decimal(15, 2)
  factorRate      Decimal         @db.Decimal(5, 4)
  termDays        Int
  paymentMethod   AdvancePaymentMethod
  paymentAmount   Decimal         @db.Decimal(15, 2)

  // Document
  documentUrl     String?
  templateId      String?

  // E-Signature
  envelopeId      String?         // DocuSign envelope ID
  signatureProvider String?

  status          ContractStatus  @default(DRAFT)
  sentAt          DateTime?
  signedAt        DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  deal            Deal            @relation(fields: [dealId], references: [id], onDelete: Cascade)
  signatures      Signature[]

  @@map("contracts")
}

model Signature {
  id            String          @id @default(cuid())
  contractId    String

  signerName    String
  signerEmail   String
  signerRole    SignerRole

  status        SignatureStatus @default(PENDING)
  signedAt      DateTime?
  ipAddress     String?

  createdAt     DateTime        @default(now())

  contract      Contract        @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("signatures")
}

enum ContractType {
  MCA_AGREEMENT
  PERSONAL_GUARANTEE
  ACH_AUTHORIZATION
  FULL_PACKAGE
}

enum AdvancePaymentMethod {
  DAILY_ACH
  WEEKLY_ACH
  SPLIT_FUNDING
}

enum ContractStatus {
  DRAFT
  SENT
  VIEWED
  PARTIALLY_SIGNED
  COMPLETED
  DECLINED
  VOIDED
  EXPIRED
}

enum SignerRole {
  MERCHANT
  GUARANTOR
  FUNDER
}

enum SignatureStatus {
  PENDING
  SIGNED
  DECLINED
}

// ============================================
// PAYMENT PROCESSING
// ============================================

model Advance {
  id                String         @id @default(cuid())
  merchantId        String
  dealId            String

  // Advance Details
  fundedAmount      Decimal        @db.Decimal(15, 2)
  paybackAmount     Decimal        @db.Decimal(15, 2)
  factorRate        Decimal        @db.Decimal(5, 4)

  // Payment Schedule
  termDays          Int
  paymentMethod     AdvancePaymentMethod
  paymentAmount     Decimal        @db.Decimal(15, 2)
  paymentFrequency  PaymentFrequency @default(DAILY)
  firstPaymentDate  DateTime

  // Balance Tracking
  totalCollected    Decimal        @db.Decimal(15, 2) @default(0)
  remainingBalance  Decimal        @db.Decimal(15, 2)

  // Status
  status            AdvanceStatus  @default(PENDING_FUNDING)
  fundedAt          DateTime?
  completedAt       DateTime?

  // Position
  position          Int            @default(1) // 1st, 2nd, 3rd position

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  merchant          Merchant       @relation(fields: [merchantId], references: [id])
  deal              Deal           @relation(fields: [dealId], references: [id])
  payments          Payment[]
  disbursements     Disbursement[]
  commissions       Commission[]
  uccFilings        UCCFiling[]

  @@map("advances")
}

model Payment {
  id              String         @id @default(cuid())
  advanceId       String

  // Payment Details
  amount          Decimal        @db.Decimal(15, 2)
  scheduledDate   DateTime
  processedDate   DateTime?

  // ACH Details
  achBatchId      String?
  achTraceNumber  String?

  // Status
  status          PaymentStatus  @default(SCHEDULED)
  returnCode      String?
  returnReason    String?

  // Retry Logic
  attemptCount    Int            @default(0)
  nextRetryDate   DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  advance         Advance        @relation(fields: [advanceId], references: [id])

  @@index([advanceId])
  @@index([scheduledDate])
  @@map("payments")
}

model Disbursement {
  id              String              @id @default(cuid())
  advanceId       String

  // Disbursement Details
  amount          Decimal             @db.Decimal(15, 2)
  method          DisbursementMethod

  // Banking Details
  bankName        String?
  routingNumber   String?
  accountNumber   String?

  // ACH/Wire Details
  referenceNumber String?

  status          DisbursementStatus  @default(PENDING)
  processedAt     DateTime?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  advance         Advance             @relation(fields: [advanceId], references: [id])

  @@map("disbursements")
}

enum PaymentFrequency {
  DAILY
  WEEKLY
}

enum AdvanceStatus {
  PENDING_FUNDING
  ACTIVE
  CURRENT
  DELINQUENT
  DEFAULT
  PAID_OFF
  SETTLED
  CHARGED_OFF
}

enum PaymentStatus {
  SCHEDULED
  PENDING
  PROCESSING
  COMPLETED
  RETURNED
  NSF
  FAILED
  CANCELLED
}

enum DisbursementMethod {
  SAME_DAY_ACH
  NEXT_DAY_ACH
  WIRE
  CHECK
}

enum DisbursementStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// AUDIT & NOTIFICATIONS
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  entityType  String
  entityId    String
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String

  type        NotificationType
  title       String
  message     String           @db.Text

  read        Boolean          @default(false)
  readAt      DateTime?

  // Link to entity
  entityType  String?
  entityId    String?

  createdAt   DateTime         @default(now())

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

model Comment {
  id          String   @id @default(cuid())
  dealId      String
  userId      String

  content     String   @db.Text
  isInternal  Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deal        Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

enum NotificationType {
  DEAL_ASSIGNED
  DEAL_STAGE_CHANGE
  DOCUMENT_UPLOADED
  DOCUMENT_VERIFIED
  CONTRACT_SIGNED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  SYSTEM
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  htmlContent String   @db.Text
  textContent String?  @db.Text
  variables   String[] // List of available variables

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}

// ============================================
// MARKETING SYSTEM
// ============================================

// Marketing Channel Sources for Attribution
enum MarketingChannel {
  AI_VOICE_OUTBOUND
  AI_VOICE_INBOUND
  SMS_CAMPAIGN
  EMAIL_CAMPAIGN
  SOCIAL_FACEBOOK
  SOCIAL_INSTAGRAM
  SOCIAL_LINKEDIN
  SOCIAL_TWITTER
  GOOGLE_ADS
  FACEBOOK_ADS
  LANDING_PAGE
  REFERRAL
  ORGANIC_SEARCH
  DIRECT
}

// Campaign Types
enum CampaignType {
  VOICE_OUTBOUND
  VOICE_INBOUND
  EMAIL
  SMS
  SOCIAL_ORGANIC
  SOCIAL_PAID
  CONTENT
  MULTI_CHANNEL
}

// Campaign Status
enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Marketing Campaigns
model Campaign {
  id              String          @id @default(cuid())
  companyId       String

  name            String
  description     String?
  type            CampaignType
  channel         MarketingChannel

  // Targeting
  targetAudience  Json?           // Industry, location, revenue range filters

  // Budget & Schedule
  budget          Decimal?        @db.Decimal(10, 2)
  spentAmount     Decimal         @db.Decimal(10, 2) @default(0)
  startDate       DateTime
  endDate         DateTime?

  // Status
  status          CampaignStatus  @default(DRAFT)

  // Performance Metrics (cached)
  impressions     Int             @default(0)
  clicks          Int             @default(0)
  conversions     Int             @default(0)
  leadsGenerated  Int             @default(0)
  dealsCreated    Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  company         Company         @relation(fields: [companyId], references: [id])
  voiceCampaign   VoiceCampaign?
  contentPosts    ContentPost[]
  adCampaigns     AdCampaign[]
  leads           MarketingLead[]

  @@index([companyId])
  @@map("campaigns")
}

// Lead Qualification Status
enum LeadQualificationStatus {
  NEW
  CONTACTED
  QUALIFIED
  UNQUALIFIED
  NURTURING
  CONVERTED
  LOST
}

// Marketing Leads (before they become Merchants)
model MarketingLead {
  id              String          @id @default(cuid())
  companyId       String
  campaignId      String?

  // Contact Info
  businessName    String?
  contactName     String?
  email           String?
  phone           String?
  website         String?

  // Business Details
  industry        String?
  annualRevenue   String?         // Range: "100k-250k", "250k-500k", etc.
  monthlyRevenue  String?
  timeInBusiness  String?         // "0-6 months", "6-12 months", etc.

  // Location
  city            String?
  state           String?
  zipCode         String?

  // Lead Scoring
  leadScore       Int             @default(0) // 0-100
  qualificationStatus LeadQualificationStatus @default(NEW)

  // Source Tracking
  source          MarketingChannel
  sourceDetail    String?         // Specific ad, post, or campaign
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?

  // Interaction History
  lastContactedAt DateTime?
  totalCalls      Int             @default(0)
  totalEmails     Int             @default(0)
  totalSms        Int             @default(0)

  // Conversion
  convertedAt     DateTime?
  merchantId      String?         // When converted to merchant
  dealId          String?         // When deal is created

  // Notes
  notes           String?         @db.Text

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  company         Company         @relation(fields: [companyId], references: [id])
  campaign        Campaign?       @relation(fields: [campaignId], references: [id])
  callLogs        CallLog[]
  interactions    LeadInteraction[]

  @@index([companyId])
  @@index([campaignId])
  @@map("marketing_leads")
}

// ============================================
// AI VOICE SYSTEM
// ============================================

// Voice Call Types
enum VoiceCallType {
  OUTBOUND_COLD
  OUTBOUND_WARM
  OUTBOUND_FOLLOWUP
  INBOUND_QUALIFICATION
  INBOUND_SUPPORT
}

// Voice Campaign Configuration
model VoiceCampaign {
  id              String          @id @default(cuid())
  campaignId      String          @unique

  // Voice Agent Configuration
  agentId         String          // External voice AI agent ID (Bland.ai, etc.)
  agentName       String
  voiceType       String          // Voice model/persona

  // Script & Prompts
  scriptTemplate  String          @db.Text
  systemPrompt    String          @db.Text
  objectionHandling Json?         // Pre-defined objection responses

  // Call Settings
  callType        VoiceCallType
  maxConcurrentCalls Int          @default(5)
  callsPerDay     Int             @default(100)
  callWindowStart String          @default("09:00") // HH:MM
  callWindowEnd   String          @default("18:00")
  timezone        String          @default("America/New_York")

  // Retry Logic
  maxRetries      Int             @default(3)
  retryInterval   Int             @default(24) // hours

  // Transfer Settings
  transferEnabled Boolean         @default(true)
  transferNumber  String?
  transferConditions Json?        // When to transfer to human

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  campaign        Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  callLogs        CallLog[]

  @@map("voice_campaigns")
}

// Call Direction
enum CallDirection {
  INBOUND
  OUTBOUND
}

// Call Status
enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  NO_ANSWER
  BUSY
  VOICEMAIL
  FAILED
  TRANSFERRED
}

// Call Outcome
enum CallOutcome {
  INTERESTED
  NOT_INTERESTED
  CALLBACK_REQUESTED
  QUALIFIED
  DISQUALIFIED
  WRONG_NUMBER
  DO_NOT_CALL
  VOICEMAIL_LEFT
  TRANSFERRED_TO_HUMAN
}

// Call Sentiment
enum CallSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

// Call Logs
model CallLog {
  id              String          @id @default(cuid())
  companyId       String
  voiceCampaignId String?
  leadId          String?
  merchantId      String?

  // Call Details
  callType        CallDirection
  fromNumber      String
  toNumber        String

  // Timing
  startedAt       DateTime
  answeredAt      DateTime?
  endedAt         DateTime?
  duration        Int             @default(0) // seconds

  // Outcome
  status          CallStatus
  outcome         CallOutcome?
  dispositionCode String?

  // AI Analysis
  transcript      String?         @db.Text
  summary         String?         @db.Text
  sentiment       CallSentiment?
  keyTopics       String[]
  actionItems     Json?

  // Quality Metrics
  aiConfidence    Decimal?        @db.Decimal(5, 4) // 0-1
  humanReviewNeeded Boolean       @default(false)

  // Recording
  recordingUrl    String?
  recordingDuration Int?

  // Notes
  notes           String?         @db.Text

  createdAt       DateTime        @default(now())

  company         Company         @relation(fields: [companyId], references: [id])
  voiceCampaign   VoiceCampaign?  @relation(fields: [voiceCampaignId], references: [id])
  lead            MarketingLead?  @relation(fields: [leadId], references: [id])

  @@index([companyId])
  @@index([voiceCampaignId])
  @@index([leadId])
  @@map("call_logs")
}

// ============================================
// CONTENT MANAGEMENT
// ============================================

// Content Media Type
enum ContentMediaType {
  IMAGE
  VIDEO
  CAROUSEL
  DOCUMENT
  LINK
}

// Content Status
enum ContentStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
  ARCHIVED
}

// Social Platform
enum SocialPlatform {
  FACEBOOK
  INSTAGRAM
  LINKEDIN
  TWITTER
  TIKTOK
  YOUTUBE
}

// Content Posts
model ContentPost {
  id              String          @id @default(cuid())
  companyId       String
  campaignId      String?

  // Content
  title           String?
  content         String          @db.Text
  contentHtml     String?         @db.Text

  // Media
  mediaType       ContentMediaType?
  mediaUrls       String[]
  thumbnailUrl    String?

  // AI Generation
  aiGenerated     Boolean         @default(false)
  aiPrompt        String?         @db.Text
  aiModel         String?

  // Platform Targeting
  platforms       SocialPlatform[]

  // Scheduling
  status          ContentStatus   @default(DRAFT)
  scheduledAt     DateTime?
  publishedAt     DateTime?

  // Performance (aggregated from platform posts)
  impressions     Int             @default(0)
  engagements     Int             @default(0)
  clicks          Int             @default(0)
  shares          Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  company         Company         @relation(fields: [companyId], references: [id])
  campaign        Campaign?       @relation(fields: [campaignId], references: [id])
  platformPosts   PlatformPost[]

  @@index([companyId])
  @@map("content_posts")
}

// Platform-specific Posts
model PlatformPost {
  id              String          @id @default(cuid())
  contentPostId   String

  platform        SocialPlatform
  platformPostId  String?         // External platform's post ID

  // Platform-specific content (may differ from main post)
  content         String?         @db.Text
  mediaUrls       String[]

  // Status
  status          ContentStatus   @default(SCHEDULED)
  publishedAt     DateTime?
  errorMessage    String?

  // Platform Metrics
  impressions     Int             @default(0)
  engagements     Int             @default(0)
  clicks          Int             @default(0)
  shares          Int             @default(0)
  comments        Int             @default(0)

  lastSyncedAt    DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  contentPost     ContentPost     @relation(fields: [contentPostId], references: [id], onDelete: Cascade)

  @@unique([contentPostId, platform])
  @@map("platform_posts")
}

// Social Media Accounts
model SocialAccount {
  id              String          @id @default(cuid())
  companyId       String

  platform        SocialPlatform
  accountName     String
  accountId       String          // Platform's account ID
  accountUrl      String?

  // OAuth Tokens (encrypted)
  accessToken     String          @db.Text
  refreshToken    String?         @db.Text
  tokenExpiresAt  DateTime?

  // Account Status
  isConnected     Boolean         @default(true)
  lastSyncedAt    DateTime?
  errorMessage    String?

  // Account Metrics
  followers       Int             @default(0)
  following       Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  company         Company         @relation(fields: [companyId], references: [id])

  @@unique([companyId, platform, accountId])
  @@map("social_accounts")
}

// ============================================
// ADVERTISING
// ============================================

// Ad Platform
enum AdPlatform {
  GOOGLE_ADS
  FACEBOOK_ADS
  INSTAGRAM_ADS
  LINKEDIN_ADS
  TWITTER_ADS
  TIKTOK_ADS
}

// Ad Campaign Status
enum AdCampaignStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  COMPLETED
  REJECTED
}

// Ad Campaigns
model AdCampaign {
  id              String          @id @default(cuid())
  campaignId      String          // Parent marketing campaign

  platform        AdPlatform
  platformCampaignId String?      // External platform's campaign ID

  // Budget
  dailyBudget     Decimal?        @db.Decimal(10, 2)
  totalBudget     Decimal?        @db.Decimal(10, 2)
  spentAmount     Decimal         @db.Decimal(10, 2) @default(0)

  // Targeting
  targetingConfig Json?           // Platform-specific targeting

  // Creatives
  adCreatives     Json?           // Ad copy, images, etc.

  // Status
  status          AdCampaignStatus @default(DRAFT)

  // Performance Metrics
  impressions     Int             @default(0)
  clicks          Int             @default(0)
  conversions     Int             @default(0)
  costPerClick    Decimal?        @db.Decimal(10, 4)
  costPerConversion Decimal?      @db.Decimal(10, 4)

  lastSyncedAt    DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  campaign        Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("ad_campaigns")
}

// ============================================
// LEAD INTERACTIONS & CRM
// ============================================

// Interaction Type
enum InteractionType {
  CALL_OUTBOUND
  CALL_INBOUND
  EMAIL_SENT
  EMAIL_RECEIVED
  SMS_SENT
  SMS_RECEIVED
  MEETING
  NOTE
  TASK
  SOCIAL_ENGAGEMENT
}

// Lead Interactions
model LeadInteraction {
  id              String          @id @default(cuid())
  leadId          String
  userId          String?         // If by a user

  type            InteractionType
  channel         MarketingChannel

  // Details
  subject         String?
  content         String?         @db.Text

  // For emails
  emailId         String?
  emailOpened     Boolean?
  emailClicked    Boolean?

  // For SMS
  smsId           String?
  smsDelivered    Boolean?

  // Outcome
  outcome         String?
  nextSteps       String?

  createdAt       DateTime        @default(now())

  lead            MarketingLead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("lead_interactions")
}

// Content Category
enum ContentCategory {
  SOCIAL_POST
  EMAIL_SUBJECT
  EMAIL_BODY
  SMS
  VOICE_SCRIPT
  BLOG_ARTICLE
  AD_COPY
  LANDING_PAGE
}

// Content Templates for AI Generation
model ContentTemplate {
  id              String          @id @default(cuid())
  companyId       String?         // Null = global template

  name            String
  description     String?
  category        ContentCategory

  // Template
  template        String          @db.Text
  variables       String[]        // Available merge fields

  // AI Settings
  aiPromptPrefix  String?         @db.Text
  aiPromptSuffix  String?         @db.Text

  // Sample Output
  sampleOutput    String?         @db.Text

  isActive        Boolean         @default(true)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("content_templates")
}
